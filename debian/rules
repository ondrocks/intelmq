#!/usr/bin/make -f

DOCS_DIR := debian/intelmq/usr/share/doc/intelmq

# Compile list of bot READMEs
BOTROOT := intelmq/bots
BOTCATEGORIES := collectors experts outputs parsers
BOTCATEGORIES := $(foreach cat,$(BOTCATEGORIES),$(BOTROOT)/$(cat))
BOTS    := $(foreach bot,$(BOTCATEGORIES),$(wildcard $(bot)/*))
BOTDOCS := $(foreach bot,$(BOTS),$(wildcard $(bot)/*.md))

# This file is based on a version
# automatically generated by stdeb 0.8.5 at
# Wed, 23 Mar 2016 17:49:26 +0000
export PYBUILD_NAME=intelmq
%:
	dh $@ --with python3 --without python2 --buildsystem=pybuild --with quilt

override_dh_auto_build:

override_dh_auto_install: $(BOTDOCS)
	python3 setup.py install --root=debian/intelmq --prefix=/usr
	mv debian/intelmq/opt/intelmq/etc/examples/* debian/intelmq/opt/intelmq/etc/
	rmdir debian/intelmq/opt/intelmq/etc/examples
	mkdir -p debian/intelmq/opt/intelmq/var/log
	mkdir -p debian/intelmq/opt/intelmq/var/lib/bots/file-output
	mkdir -p debian/intelmq/etc/logrotate.d
	## BOTS
	# Include all bot READMEs
	for readme in $(foreach bot,$(BOTDOCS),$(subst intelmq/bots/,,$(bot))); \
	do \
		mkdir -p $(DOCS_DIR)/bots/$$(dirname $$readme); \
		cp intelmq/bots/$$readme $(DOCS_DIR)/bots/$$(dirname $$readme); \
	done
